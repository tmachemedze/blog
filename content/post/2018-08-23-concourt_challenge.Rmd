---
title: "Zim Elections Constitutional Court Hearing in Tweets"
author: "TM"
date: "2018-08-23"
output:
  html_document:
    df_print: paged
---

## Introduction

Harmonised elections recently held in Zimbabwe (30/07/2018) were disputed by the leading opposition party, MDC-Alliance. Therefore, they petitioned the Constitional Court to overturn President Emmerson Mnangagwa's victory as announced by the electoral board, Zimbabwe Electoral Commission (ZEC). The Constitutional court hearing was on 22 Agust 2018 and was trending by the twitter hashtags; **#ConCourtdecides**, **#ConCourtZW**, **#ElectionPetitionZW**, **#ZimConCourt**, **#zimconcourtchallenge**. The court ruling was also set for the 24th of August 2018. I took this opportunity to assess the mood of people (mostly Zimbabweans) as they express themselves on twitter with regard to the proceedings of both the court hearing and ruling. Data was downloaded from the twitter API using the hashtags (mentioned above) as search terms and results are presented below.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(rtweet)
library(lubridate)
library(ggplot2)
library(dplyr)
library(syuzhet)
library(tidyquant)

tweets <- read_twitter_csv("zim_concourtdecides_2018.csv")
tweets$time=ymd_hms(tweets$created_at)
tweets$text2=tweets$text #to use after sentiment analysis
```

```{r, echo=FALSE}
#Clean-up
tweets$text = gsub("&amp", "", tweets$text)
tweets$text = gsub("(RT|via)((?:\\b\\W*@\\w+)+)", "", tweets$text) #remove retweet entities
tweets$text = gsub("@\\w+ *", "",tweets$text) #remove handles with text
tweets$text = gsub("#\\w+ *", "",tweets$text) #remove hashtag
tweets$text = gsub("[[:punct:]]", "", tweets$text) #remove punctuation
tweets$text = gsub("[[:digit:]]", "", tweets$text) #remove numbers
tweets$text = gsub("http\\w+", "", tweets$text) #remove html links
tweets$text = gsub("[ \t]{2,}", "", tweets$text) #remove unnecessary spaces
tweets$text = gsub("^\\s+|\\s+$", "", tweets$text) 
tweets$text = gsub("\\.|http+ *", "",tweets$text)
tweets$text <- iconv(tweets$text, "UTF-8", "ASCII", sub="")
```

### Hourly tweets: 21-08-2018 to 26-08-2018

```{r, echo=FALSE}
tweets %>% 
  filter(time >= as.Date("2018-08-21")) %>% 
  ts_plot("hours") +
  labs(x = "Date and time",
       y = "Frequency of tweets",
       title = "Time series of consititutional court hashtag tweets",
       subtitle = "Frequency of related twitter statuses calculated in one-hour intervals" ) +
  theme_classic()
```

We can see peaks for frequency of related tweets on both the court day and court ruling day. From here, we break the analysis into two parts: the court hearing and the court ruling 

## Court hearing analysis

### Hourly tweets on the court hearing

```{r, echo=FALSE}
p1<-tweets %>% 
  filter(as_date(time) == as.Date("2018-08-22")) %>% 
  ts_plot("hours") +
  labs(x = "Date and time",
       y = "Frequency of tweets",
       title = "Time series of tweets on court hearing",
       subtitle = "Frequency of related twitter statuses calculated in one-hour intervals" ) +
  theme_classic()
p1
```

Tweets peaked mid-morning of the court date between 9:00am and 11:00am. This is roughly around the time when court was determining whether co-respondents who filed their papers could be heard. The final decision not to consider co-respondents made around that time could have influenced more reactions on twitter.

### Word cloud: court hearing (22/08/2018)

The word cloud shows the distribution of frequently used words. We included words that were used at least 10 times. The larger the size of the word, the more frequent it was used.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidytext)
library(SnowballC)
library(stringr)
## tokenize by word
reduced_tweets<-tweets %>% filter(time >= as.Date("2018-08-22") & time < as.Date("2018-08-23")) %>% 
  mutate(text=gsub("@\\w+ *", "",text)) %>% #remove handles with text
  mutate(text=gsub("#\\w+ *", "",text)) %>%  #remove hashtag
  mutate(text=gsub("\\.|http+ *", "",text))
  

reduced_tweets1 <- reduced_tweets %>%
  select(created_at, text, source,screen_name) %>% 
  unnest_tokens(word, text) %>%
  mutate(word_stem = wordStem(word)) %>%
  anti_join(stop_words, by = "word") %>%
  #anti_join(my_stop_words, by = "word") %>%
  filter(!grepl("\\.|http", word)) %>% #remove urls
  filter(!str_detect(word, "[0-9]"), #remove numbers
         word != "amp",word != "tco") #remove amp

wrds<-table(reduced_tweets1$word)


## get some good colors
cols <- sample(rainbow(10, s = .5, v = .75), 10)

## plot word cloud
suppressWarnings(wordcloud::wordcloud(
  words = names(wrds),
  freq = wrds,
  min.freq = 10,
  random.color = FALSE,
  random.order = FALSE,
  colors = cols,
  scale = c(4.75, .5))
)
```

"Court", "evidence" and "Adv" "Thabani" "Mpofu" were among the most mentioned. This is mostly because Adv Thabani Mpofu was representing the applicant and had to prove his case. Twimbos and other followers had varying opinions over his representation - both ways.


### Sentiment analysis: court hearing

Here, sentiment analysis is applied to identify reactions, attitudes and emotions. In this case, we used the `nrc` lexicon that categorizes words into emotions of **positive**, **negative**, **anger**, **anticipation**, **disgust**, **fear**, **joy**, **sadness**, **surprise**, and **trust**. We filtered out "positive" and "negative" emotion categories because of negated words that changes the meaning of the context.

```{r, echo=FALSE}
## conduct sentiment analysis
#syuzhet package
hearing_tweets<-tweets %>% filter(time >= as.Date("2018-08-22") & time < as.Date("2018-08-23"))
sa_hearing <- syuzhet::get_nrc_sentiment(hearing_tweets$text)

df <- cbind(hearing_tweets, sa_hearing)


## load dplyr
## use pipe (%>%) operator for linear syntax
long_emotion_ts <- df %>%
  ## select variables (columns) of interest
  dplyr::mutate(created_at=ymd_hms(created_at)) %>%
  dplyr::select(created_at, anger:trust) %>%  #ignore positive and negative
  ## convert created_at variable to desired interval
  mutate(created_at = round_date(created_at, "30 mins")) %>% 
  ## transform data to long form
  tidyr::gather(sentiment, score, -created_at) %>%
  ## group by time, query, and sentiment
  group_by(created_at, sentiment) %>%
  ## get mean for each grouping
  summarize(score = mean(score, na.rm = TRUE),
            n = n()) %>%
  ungroup()

# plot data
long_emotion_ts %>%
  ggplot(aes(x = created_at, y = score)) +
  geom_point() +
  geom_smooth(method = "loess") +
  facet_wrap(~ sentiment, scale = "free_y", nrow = 2) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        legend.position = "bottom",
        axis.text = element_text(size = 9),
        legend.title = element_blank(),
        axis.text.x=element_text(angle=90)) +
  labs(x = NULL, y = NULL,
       title = "Sentiment analysis over time",
       subtitle = "Tweets aggregated by 30 minutes") +
  scale_x_datetime(date_breaks = "6 hour", date_labels = "%H %M")
```

The sentiment analysis exclude non-english words and most of these are Shona words (you can see words like "hapana", "kana", "nhasi", "vanhu" in the word cloud). Perhaps someone can create Shona sentiment categories. I am particularly interested in the time period between 06:00 and end of day where we see an increasing number of related tweets. The NRC sentiment analysis shows that:

1. There are flactuations in expression of **anger** that generally falls down over the course of the court hearing.

2. There is an initial high **anticipation** that dumpened from mid-morning.

3. There is a general increase in **disgust**.

4. There was increasing **fear** from morning upto around 10am and became less thereafter.

5. Most twimbos started the day with expression of **joy** that was dumpened by mid-morning.

6. There is generally increasing **sadness** over the course of the day.

7. Initially, there is high **surprise** that slowed down and flattened over time.

8. **Trust** started high and was dumpened by mid-morning and then flactuating thereafter.


### Distribution of emotion categories: court hearing

The graph below shows the frequency of words falling in each category of emotions.

```{r, echo=FALSE}
emotion_bar = colSums(sa_hearing)
emo_sum = data.frame(count=emotion_bar, emotion=names(emotion_bar))
emo_sum = emo_sum[emo_sum$emotion!="positive" & emo_sum$emotion!="negative",]
emo_sum$emotion = factor(emo_sum$emotion, levels=emo_sum$emotion[order(emo_sum$count, decreasing = TRUE)])

ggplot(emo_sum, aes(emotion,count)) + 
  geom_col() +
  theme_tq() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(title="Distribution of emotion categories: court hearing")
```

Sentiments of trust tops in the words used.

### Word cloud of sentiments:court hearing

As opposed to the previous word cloud that uses all words, here we create a word cloud based on the sentiments derived from the tweets. Generally, most of the words in this word cloud match the lexicon definition but there are also other words that appear because of the tweet they come from than their sentiment. For example, if a "trust" word appears frequently in tweets expressing "joy", that word might appear in this word cloud as "joy" because of association and its frequency and not its sentiment.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tm)
library(wordcloud)
wordcloud_tweet = c(
  paste(hearing_tweets$text[sa_hearing$anger > 0], collapse=" "),
  paste(hearing_tweets$text[sa_hearing$anticipation > 0], collapse=" "),
  paste(hearing_tweets$text[sa_hearing$disgust > 0], collapse=" "),
  paste(hearing_tweets$text[sa_hearing$fear > 0], collapse=" "),
  paste(hearing_tweets$text[sa_hearing$joy > 0], collapse=" "),
  paste(hearing_tweets$text[sa_hearing$sadness > 0], collapse=" "),
  paste(hearing_tweets$text[sa_hearing$surprise > 0], collapse=" "),
  paste(hearing_tweets$text[sa_hearing$trust > 0], collapse=" ")
)

# create corpus
corpus = Corpus(VectorSource(wordcloud_tweet))

# remove punctuation, convert every word in lower case and remove stop words

corpus = tm_map(corpus, tolower)
corpus = tm_map(corpus, removePunctuation)
corpus = tm_map(corpus, removeWords, c(stopwords("english"),"luke","malaba","mpofu","mpofus","kanengoni","zimbabwe","zimbabwean","manyika","manyikas","shumba", "shumbas","zanu","zanupf","mdc","concourtzw","nelson","chamisa","chamisas","hee","zec","dambudzo","emmerson","mnangagwa","mnangagwas","mugabe","gore","zim"))
#corpus = tm_map(corpus, stemDocument)

# create document term matrix

tdm = TermDocumentMatrix(corpus)

# convert as matrix
tdm = as.matrix(tdm)
tdmnew <- tdm[nchar(rownames(tdm)) < 11,]

# column name binding
colnames(tdm) = c('anger', 'anticipation', 'disgust', 'fear', 'joy', 'sadness', 'surprise', 'trust')
colnames(tdmnew) <- colnames(tdm)
comparison.cloud(tdmnew, random.order=FALSE,
                 colors = c("#00B2FF", "red", "#FF0099", "#6600CC", "green", "orange", "blue", "brown"),
                 title.size=1, max.words=250, scale=c(2.5, 0.4),rot.per=0.4)

```

We can see some of the words and their associated emotion categories. 


## Court ruling analysis

### Hourly tweets on the court ruling

```{r, echo=FALSE}
p2<-tweets %>% 
  filter(as_date(time) == as.Date("2018-08-24")) %>% 
  ts_plot("hours") +
  labs(x = "Date and time",
       y = "Frequency of tweets",
       title = "Time series of tweets on court ruling",
       subtitle = "Frequency of related twitter statuses calculated in one-hour intervals" ) +
  theme_classic()

p2
#cowplot::plot_grid(p1, p2, ncol=1)
```

Court ruling was initially set for 14:00 on the 24th of August. The time was changed to 15:00 and the announcement was made in the court room at around 14:00. This explains the peak at the 2 o'clock hour of people expressing their anxiety and disappointment of this change in time. 

### Word cloud: court ruling (24/08/2018)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidytext)
library(SnowballC)
library(stringr)
## tokenize by word
reduced_tweets<-tweets %>% filter(time >= as.Date("2018-08-24") & time < as.Date("2018-08-25")) %>% 
  mutate(text=gsub("@\\w+ *", "",text)) %>% #remove handles with text
  mutate(text=gsub("#\\w+ *", "",text)) %>%  #remove hashtag
  mutate(text=gsub("\\.|http+ *", "",text))

reduced_tweets1 <- reduced_tweets %>%
  select(created_at, text, source,screen_name) %>% 
  unnest_tokens(word, text) %>%
  mutate(word_stem = wordStem(word)) %>%
  anti_join(stop_words, by = "word") %>%
  #anti_join(my_stop_words, by = "word") %>%
  filter(!grepl("\\.|http", word)) %>% #remove urls
  filter(!str_detect(word, "[0-9]"), #remove numbers
         word != "amp",word != "tco") #remove amp

wrds<-table(reduced_tweets1$word)
#head(sort(wrds, decreasing = TRUE), 40)

## get some good colors
cols <- sample(rainbow(10, s = .5, v = .75), 10)

## plot word cloud
suppressWarnings(wordcloud::wordcloud(
  words = names(wrds),
  freq = wrds,
  min.freq = 10,
  random.color = FALSE,
  random.order = FALSE,
  colors = cols,
  scale = c(4.75, .5))
)
```

It is not surprising that tweets on the court ruling were dominated by "Malaba", the Chief Justice, as he was presenting the ruling over the case.

### Sentiment analysis: court ruling

```{r, echo=FALSE}
# Filtering topics
## create plain tweets variable
#tweets$text_plain <- plain_tweets(tweets$text)

## conduct sentiment analysis
#syuzhet package
ruling_tweets<-tweets %>% filter(time >= as.Date("2018-08-24") & time < as.Date("2018-08-25"))
sa_ruling <- syuzhet::get_nrc_sentiment(ruling_tweets$text)


## view output
#tibble::as_tibble(sa)

df <- cbind(ruling_tweets, sa_ruling)


## load dplyr
## use pipe (%>%) operator for linear syntax
long_emotion_ts <- df %>%
  ## select variables (columns) of interest
  dplyr::mutate(created_at=ymd_hms(created_at)) %>%
  dplyr::select(created_at, anger:trust) %>%  #ignore positive and negative (anger:positive)
  ## convert created_at variable to desired interval
  mutate(created_at = round_date(created_at, "30 mins")) %>% 
  ## transform data to long form
  tidyr::gather(sentiment, score, -created_at) %>%
  ## group by time, query, and sentiment
  group_by(created_at, sentiment) %>%
  ## get mean for each grouping
  summarize(score = mean(score, na.rm = TRUE),
            n = n()) %>%
  ungroup()

# plot data
long_emotion_ts %>%
  ggplot(aes(x = created_at, y = score)) +
  geom_point() +
  geom_smooth(method = "loess") +
  facet_wrap(~ sentiment, scale = "free_y", nrow = 2) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        legend.position = "bottom",
        axis.text = element_text(size = 9),
        legend.title = element_blank(),
        axis.text.x=element_text(angle=90)) +
  labs(x = NULL, y = NULL,
       title = "Sentiment analysis of over time",
       subtitle = "Tweets aggregated by 30 minutes") +
  scale_x_datetime(date_breaks = "6 hour", date_labels = "%H %M")
```

1. There is increasing expression of **anger**, **anticipation**, **disgust**, **fear**, **joy**, **sadness** and **surprise** after the court ruling.

2. There are also flactuations in **trust** that generally end on a low.

#### Tweets expressing sentiments of joy

It is curious to note that when other negative emotions are going up, **joy** is also going up. Below we extract some of the tweets associated with sentiments of joy to see what is happening. We take a sample of six related tweets that were twitted after 17:00.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#head(df[df$joy>0 & df$time>=ymd_hms("2018-08-24 16:00:00 UTC"),c("created_at","text")])
tab<-head(df[df$joy>0 & df$time>=ymd_hms("2018-08-24 17:00:00 UTC"),c("created_at","text2")])
library(knitr)
library(kableExtra)
kable(tab, format = "html", col.names = c("created_at","text"), caption = "Joy related tweets") %>% 
  kable_styling(c("striped", "hover", "condensed", "bordered"))
```

Generally, the above tweets have mixed emotions. Joy related emotion/sentiment are derived from words like "victory", "clown", "God", "respect", "celebrating" and "dawn". This example illustrates that computers are far from taking over some human jobs, we still need human judgement. This is because lexicon based sentiment analysis fails to understand context, sarcasm, multiple languages and other variations in sentence construction. However, there are some tweets suggesting that the ruling was celebrated by others.

### Distribution of emotion categories: court ruling

```{r, echo=FALSE}
emotion_bar = colSums(sa_ruling)
emo_sum = data.frame(count=emotion_bar, emotion=names(emotion_bar))
emo_sum = emo_sum[emo_sum$emotion!="positive" & emo_sum$emotion!="negative",]
emo_sum$emotion = factor(emo_sum$emotion, levels=emo_sum$emotion[order(emo_sum$count, decreasing = TRUE)])

ggplot(emo_sum, aes(emotion,count)) + 
  geom_col() +
  theme_tq() +
  theme(axis.text.x=element_text(angle=90)) +
  labs(title="Distribution of emotion categories: court ruling")
```

Again, words of trust are the most frequent.

### Word cloud of sentiments:court ruling

Like above, we also present a word cloud of sentiments on the court ruling.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tm)
library(wordcloud)
wordcloud_tweet = c(
  paste(ruling_tweets$text[sa_ruling$anger > 0], collapse=" "),
  paste(ruling_tweets$text[sa_ruling$anticipation > 0], collapse=" "),
  paste(ruling_tweets$text[sa_ruling$disgust > 0], collapse=" "),
  paste(ruling_tweets$text[sa_ruling$fear > 0], collapse=" "),
  paste(ruling_tweets$text[sa_ruling$joy > 0], collapse=" "),
  paste(ruling_tweets$text[sa_ruling$sadness > 0], collapse=" "),
  paste(ruling_tweets$text[sa_ruling$surprise > 0], collapse=" "),
  paste(ruling_tweets$text[sa_ruling$trust > 0], collapse=" ")
)

# create corpus
corpus = Corpus(VectorSource(wordcloud_tweet))

# remove punctuation, convert every word in lower case and remove stop words

corpus = tm_map(corpus, tolower)
corpus = tm_map(corpus, removePunctuation)
corpus = tm_map(corpus, removeWords, c(stopwords("english"),"luke","malaba","mpofu","mpofus","kanengoni","zimbabwe","zimbabwean","manyika","manyikas","shumba", "shumbas","zanu","zanupf","mdc","concourtzw","nelson","chamisa","chamisas","hee","zec","dambudzo","emmerson","mnangagwa","mnangagwas","mugabe","gore","zim"))
#corpus = tm_map(corpus, stemDocument)
corpus=tm_map(corpus, stripWhitespace)

# create document term matrix

tdm = TermDocumentMatrix(corpus)

# convert as matrix
tdm = as.matrix(tdm)
tdmnew <- tdm[nchar(rownames(tdm)) < 11,]

# column name binding
colnames(tdm) = c('anger', 'anticipation', 'disgust', 'fear', 'joy', 'sadness', 'surprise', 'trust')
colnames(tdmnew) <- colnames(tdm)
comparison.cloud(tdmnew, random.order=FALSE,
                 colors = c("#00B2FF", "red", "#FF0099", "#6600CC", "green", "orange", "blue", "brown"),
                 title.size=1, max.words=250, scale=c(2.5, 0.4),rot.per=0.4)

```

## Conclusions

Clearly, the court hearing was followed by a significant number of twimbos. There are various patterns of sentiments expressed over the course of the court hearing. Twimbos who expresed themselves on twitter were generally not happy with the court ruling as shown by rising negative emotions. There is also a segment of twimbos who appear to express joy on the ruling. We also acknowledge that the sentiment detection methods are not 100% reliable based on what we observed with the "joy" sentiment. Through following some twitter handles, I observed that there are threads where the court proceedings were discussed but without using the above mentioned hashtags. Therefore, some related tweets were missed and these could have an effect on the results.
